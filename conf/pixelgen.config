
// Include this to make sure we don't override
// all values, but only those define in here.
includeConfig "./modules.config"

def pixelgenOutputDir(workflow, params) {
    //pixelator-results/<flowcell identifer>/<nf-core-pixelator version>-<pixelator version>/<date>-<sha>/

    // TODO Do we want to assume that the dir one start the pipeline in is the
    // flowcell?
    flowcellName = launchDir.getFileName()

    pipelineVersion = workflow.manifest.version

    // TODO We should perhaps use a paramater rather than set this
    // expliclity all over the place to simplify this.
    pixelatorVersion = params.pixelator_tag ?: "unknown"

    today = new Date().format("yyyy-MM-dd")
    samplesheet = new File(params.input)
    samplesheetSha = samplesheet.bytes.digest('sha-1')
    parameterSha = (params.sort()*).toString().digest('sha-1')
    combinedSha = "${samplesheetSha}${parameterSha}"//.digest("sha-1").substring(0, 6)

    return "${flowcellName}/${pipelineVersion}/${pixelatorVersion}/${today}/${combinedSha}"

}

// TODO Make path depend on output dir
// "${params.outdir}"

process {

    withName: "PIXELATOR.*" {
        publishDir = [
            [
                path: {
                    "${params.outdir}/${pixelgenOutputDir(workflow, params)}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}"
                    },
                mode: "${params.publish_dir_mode}",
                saveAs: { filename -> (filename.endsWith('.log') || filename.equals('versions.yml')) ? null : filename }
            ],
            [
                path: { "${params.outdir}/${pixelgenOutputDir(workflow, params)}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}/logs" },
                mode: params.publish_dir_mode,
                pattern: "*.log"
            ]
        ]
    }

    // TODO Add other processes here!
}
